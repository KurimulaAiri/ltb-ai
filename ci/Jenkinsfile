pipeline {
    agent any

    tools {
        jdk 'Java 21'  // 引用全局配置的JDK
        maven 'Maven 3.9'  // 引用全局配置的Maven
    }

    // 定义部署目录（同机部署的目标路径，需确保jenkins用户有权限）
    environment {
        // 定义日期变量：格式为 yyyy-MM-dd-HH-mm（根据需求调整）
        CURRENT_DATE = sh(script: 'date +%Y-%m-%d:%H:%M', returnStdout: true).trim()
        DEPLOY_DIR = '/opt/java/ai'  // 应用部署目录
        JAR_NAME = "${ARTIFACT_ID}-${VERSION}.jar"    // 构建后的jar包名称（需与项目pom.xml的artifactId一致）
        JAVA_OPTS = "-Xms512m -Xmx1024m -XX:MaxMetaspaceSize=256m"  // JVM参数（根据实际情况调整）
        LOG_FILE = "${DEPLOY_DIR}/app-${CURRENT_DATE}.log"  // 应用日志文件路径
    }


    stages {
        // 阶段1：拉取代码（与跨机部署一致）
        stage('拉取代码') {
            steps {
                checkout scm  // 拉取Git仓库代码（需提前配置Git凭证）
            }
        }

        // 新增阶段：提取pom.xml中的artifactId和version
        stage('提取版本信息') {
            steps {
                script {
                    // 提取artifactId（从pom.xml中）
                    echo "当前时间：${CURRENT_DATE}"

                    def artifactId = sh(
                        script: 'mvn help:evaluate -Dexpression="project.artifactId" -q -DforceStdout',
                        returnStdout: true
                    ).trim()  // 去除换行符和空格

                    // 提取version（从pom.xml中）
                    def version = sh(
                        script: 'mvn help:evaluate -Dexpression="project.version" -q -DforceStdout',
                        returnStdout: true
                    ).trim()

                    env.ARTIFACT_ID = artifactId
                    env.VERSION = version

                    echo "提取到项目信息：artifactId=${env.ARTIFACT_ID}，version=${env.VERSION}，jar包名称=${env.ARTIFACT_ID}-${env.VERSION}.jar"
                }
            }
        }

        // 阶段2：构建打包（跳过测试可加-Dmaven.test.skip=true）
        stage('构建打包') {
            steps {
                sh 'mvn clean package -Pprod -f pom.xml'
            }
            post {
                success {
                    archiveArtifacts artifacts: "target/${env.ARTIFACT_ID}-${env.VERSION}.jar", fingerprint: true  // 归档jar包
                }
            }
        }

        // 阶段3：部署到本地（同机部署核心步骤）
        stage('本地部署') {
            steps {
                script {
                    // 动态jar包名称（当前构建的版本）
                    def currentJar = "${env.ARTIFACT_ID}-${env.VERSION}.jar"
                    // 旧jar包的通配符（匹配同一项目的所有版本，用于停止旧进程）
                    def oldJarPattern = "${env.ARTIFACT_ID}-.*.jar"

                    // 1. 创建部署目录
                    sh "mkdir -p ${DEPLOY_DIR}"

                    // 2. 复制新jar包到部署目录
                    sh "cp target/${currentJar} ${DEPLOY_DIR}/"

                    echo "旧jar包：${oldJarPattern}，已复制到部署目录，停止旧进程"

                    // 3. 停止旧版本应用进程（通过jar包名前缀匹配）
                    sh """
                        echo '查找所有包含 ${oldJarPattern} 前缀的jar包进程'
                        # 1. 获取PID（用ps+grep更兼容，避免pgrep的匹配问题）
                        PID=\$(ps aux | grep -v grep | grep -E '${oldJarPattern}' | awk '{print \$2}')

                        # 2. 正确判断PID是否非空（用双引号解析变量，-n判断非空）
                        if [ -n "\$PID" ]; then
                            echo "停止旧进程：\$PID"
                            # 仅当PID非空时执行kill，避免错误
                            kill -9 \$PID
                            sleep 1  # 等待进程退出
                        else
                            echo "无旧进程运行"
                        fi
                    """

                    echo "当前jar包：${currentJar}，正在启动..."

                    def otherOpts = ">> ${LOG_FILE} 2>&1 &"

                    withEnv(["JENKINS_NODE_COOKIE=dontkillme"]) {
                        // 4. 启动新应用（使用动态jar包名称）
                        sh """
                            # 1. 验证Java环境
                            echo "Java环境验证："
                            java -version || echo "Java环境异常！"

                            # 2. 调试：打印变量和完整命令（关键排查用）
                            echo "部署目录：${DEPLOY_DIR}"
                            echo "当前jar包：${currentJar}"

                            # 3. 执行启动命令（用单引号包裹，避免参数拆分）

                            echo "完整启动命令：nohup java -jar ${DEPLOY_DIR}/${currentJar} ${JAVA_OPTS} ${otherOpts}"

                            nohup sh -c "java -jar ${DEPLOY_DIR}/${currentJar} ${JAVA_OPTS} ${otherOpts}"

                            # 4. 验证进程是否启动
                            sleep 3
                        """
                    }


                    echo "验证启动结果"

                    // 5. 验证启动结果
                    sh """
                        NEW_PID=\$(ps aux | grep -v grep | grep -E '${currentJar}' | awk '{print \$2}')
                        if [ -n "\$NEW_PID" ]; then
                            echo "应用启动成功，进程ID：\$NEW_PID（jar包：${currentJar}）"
                        else
                            echo "启动失败！查看日志：${DEPLOY_DIR}/app-${CURRENT_DATE}.log"
                            exit 1
                        fi
                    """
                }
            }
        }
    }

    // 构建结果通知（可选）
    post {
        success {
            echo "同机部署成功！应用路径：${DEPLOY_DIR}/${env.ARTIFACT_ID}-${env.VERSION}.jar"
        }
        failure {
            echo "部署失败！查看控制台输出或日志：${LOG_FILE}"
        }
    }
}